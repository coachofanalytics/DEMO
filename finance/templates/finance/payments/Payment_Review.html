{% extends "main/base_templates/base.html" %}
{% load crispy_forms_tags %}
{% block content %}
<div class="header">
    DC48K Finance Department
</div>
<div class="instructions">
    <p>
        Generate your payment plan by selecting the payment options below, then download and print your customized plan. 
        After downloading, please leave a message on our 
        <a href="https://wa.me/14174137966" target="_blank">WhatsApp</a> with your plan file, or email us at 
        <strong><a href="mailto:info@codanalytics.net">info@DC48K</a></strong> for further assistance. 
        <br><br>
    </p>
</div>

<div style="width: 50%; margin: 0 auto; text-align: center; margin-bottom: 8px;">   
    <label for="totalAmount">Total Payment Amount:</label>
    <div class="styled-input" id="totalAmount" tabindex="0">
        {{ pay_amount }}$
    </div>
    <!-- Payment Frequency Dropdown -->
    <label for="paymentFrequency">Payment Frequency:</label>
    <select id="paymentFrequency">
        <option value="15">Every 15 Days</option>
        <option value="30">Every 1 Month</option>
    </select>
    
    <label for="numInstallments">Number of Payments:</label>
    <input type="number" id="numInstallments" min="1" max="7" placeholder="Enter number of Payments" value="7">
    
    <br>
    <button id="calculateButton">Calculate Payment</button>
</div>

<div class="container" id="container">
    <div class="plan-info">
        {% for payment in payment_info %}
            <h2>Payment Plan for {{ payment.customer.username }}</h2>
        {% endfor %}
        
        <div class="amounts" id="installmentDisplay">
            <div class="row1"></div>
            <div class="row2"></div>
        </div>
    </div>
    
    <h3>Payment Details</h3>
    <table class="table table-borderless">
        <tr>
            <th>Fee Balance</th>
            <td>3500$</td>
        </tr>
        <tr>
            <th>Cash app:</th>
            <td>$dc48kinfo</td>
        </tr>
        <tr>
            <th>Zelle:</th>
            <td>info@dc48k</td>
        </tr>
        <tr>
            <th>Mpesa:</th>
            <td>
                <li style="list-style: none;">Paybill: 600100</li>
                <li style="list-style: none;">Account No : 0100008710958</li>
            </td>
        </tr>
        <tr>
            <th>Contract Submitted Date</th>
            <td>July 16, 2024, 10:53 a.m.</td>
        </tr>
     
    </table>
</div>

<!-- Contact Section -->
<div class="contact-section">
    <p>If you have any questions or need assistance, please contact us via 
        <a href="https://wa.me/14174137966" target="_blank">WhatsApp</a> or 
        <a>email: info@DC48K</a>.
    </p>
</div>

<div class="button-container">
    <button class="print-button" onclick="saveAsPDF();">Print Payment Plan</button>
    
</div>

<!-- Existing Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>

<!-- Updated JavaScript -->
<script>
    // Event Listener Initialization Function
    function reinitializeEventListeners() {
        document.getElementById('calculateButton').addEventListener('click', calculatePayments);
        
        // Set default number of installments to 6
        document.getElementById('numInstallments').value = 7;
        
        // Trigger calculation on page load
        calculatePayments();
    }

    /**
     * Calculate and Display Payment Installments
     */
    function calculatePayments() {
        // Retrieve Total Amount
        const totalAmountText = document.querySelector('#totalAmount').textContent.trim();
        const totalAmount = parseFloat(totalAmountText.replace('$', ''));
        
        // Retrieve Number of Installments
        const numInstallments = parseInt(document.getElementById('numInstallments').value);
        
        // Retrieve Payment Frequency (15 or 30 days)
        const paymentFrequency = parseInt(document.getElementById('paymentFrequency').value); // 15 or 30

        // Input Validation
        if (isNaN(totalAmount) || totalAmount <= 0) {
            alert("Please enter a valid amount.");
            return;
        }
        if (isNaN(numInstallments) || numInstallments < 1) {
            alert("Please enter a valid number of payments.");
            return;
        }

        // Set maximum number of installments to 6
        const maxInstallments = 7;
        if (numInstallments > maxInstallments) {
            alert(`The number of payments should be ${maxInstallments} or less.Further contact us on Whatsapp or email shown at the end of the page.`);
            return;
        }

        // Calculate Installment Amount
        const installmentAmount = (totalAmount / numInstallments).toFixed(2);
        
        // Select the Display Rows
        const installmentDisplayRow1 = document.querySelector('#installmentDisplay .row1');
        const installmentDisplayRow2 = document.querySelector('#installmentDisplay .row2');
        
        // Clear Previous Installments
        installmentDisplayRow1.innerHTML = '';
        installmentDisplayRow2.innerHTML = '';

        // Generate Installment Details
        for (let i = 0; i < numInstallments; i++) {
            const installmentDiv = document.createElement('div');
            installmentDiv.classList.add('part');
            installmentDiv.innerHTML = `
                <h4>Payment No: ${i + 1}</h4>
                <p>Amount: $${installmentAmount}</p>
                <p>Due Date: ${getDueDate(i, paymentFrequency)}</p>
            `;
            
            // Distribute Installments Between Rows
            if (i < Math.ceil(numInstallments / 2)) {
                installmentDisplayRow1.appendChild(installmentDiv);
            } else {
                installmentDisplayRow2.appendChild(installmentDiv);
            }
        }
    }

    /**
     * Calculate Due Date Based on Installment Index and Frequency
     * @param {number} installmentIndex - The current installment number (0-based)
     * @param {number} frequency - Payment frequency in days (15 or 30)
     * @returns {string} - Formatted due date
     */
    function getDueDate(installmentIndex, frequency) {
        const today = new Date();
        const dueDate = new Date(today);

        // Calculate Days to Add Based on Frequency
        dueDate.setDate(dueDate.getDate() + (installmentIndex + 1) * frequency);

        // Format the Date (e.g., MM/DD/YYYY)
        return dueDate.toLocaleDateString();
    }

    // Initialize Event Listeners on Page Load
    document.addEventListener('DOMContentLoaded', reinitializeEventListeners);
</script>

<!-- Existing Save as PDF Script -->
<script>
    async function saveAsPDF() {
        // Define custom header content for print
        const customHeader = `
            <div class="header">
               Codanalytics Finance Department
            </div>
        `;

        // Get the main content from the container
        const containerContent = `
            ${customHeader}
            ${document.querySelector('.container').outerHTML}
        `;

        // Capture head content to apply current styles in the print window
        const headContent = document.head.innerHTML;

        // Create a new print window
        const printWindow = window.open('', '_blank');
        printWindow.document.open();

        // Write the document content with head and container
        printWindow.document.write(`
            <html>
                <head>
                    ${headContent}
                    <style>
                        /* Ensure consistent color and style for printing */
                        @media print {
                            * {
                                -webkit-print-color-adjust: exact !important;
                                color-adjust: exact !important;
                            }
                              
                            .header {
                                background: rgb(7, 7, 73) !important;
                                color: white !important;
                                padding: 20px !important;
                                text-align: center !important;
                                font-size: 40px !important;
                                font-weight: bold !important;
                                height: 200px !important;
                                display: flex !important;
                                justify-content: center !important;
                                align-items: center !important;
                            }
                            .container {
                               
                                padding: 20px !important;
                                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1) !important;
                               
                            }
                            h2 {
                                text-align: center !important;
                                color: #0b1c7a !important;
                                margin-bottom: 15px !important;
                            }
                            .amounts {
                                    display: flex !important;
                                    flex-direction: column !important;
                                    gap: 10px !important;
                                    margin: 20px 0 !important;
                                }

                            .amounts .row1,
                            .amounts .row2 {
                                    display: flex !important;
                                    justify-content: space-between !important;
                                    gap: 10px !important;
                                }

                                .part {
                                    flex: 1 !important;
                                    border: 1px solid #ccc !important;
                                    padding: 20px !important;
                                    text-align: center !important;
                                    margin: 0 10px !important;
                                    border-radius: 8px !important;
                                    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1) !important;
                                    transition: transform 0.2s !important;
                                }
                            .table-borderless th,
                            .table-borderless td {
                                border: none !important;
                                padding: 10px !important;
                                text-align: left !important;
                            }
                            /* Hide unnecessary UI elements for print */
                            .button-container, .send-button, .print-button, .contact-section {
                                display: none !important;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${containerContent}
                </body>
            </html>
        `);

        printWindow.document.close();

        // Wait for the print window content to load, then initiate print
        printWindow.addEventListener('load', () => {
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        });

        const { jsPDF } = window.jspdf;

        const containerElement = document.querySelector('.container'); // Element to capture
        const pdf = new jsPDF();

        // Capture the element as an image
        await html2canvas(containerElement).then((canvas) => {
            const imgData = canvas.toDataURL('image/png');
            pdf.addImage(imgData, 'PNG', 10, 10, 180, 0); // Adjust dimensions as needed
        });

        // Save PDF to backend server
        const username = "{{username}}"
        console.log(username)
        const pdfFileName = `${username}_payment_plan.pdf`;
        const pdfBlob = pdf.output('blob');
        const formData = new FormData();
        formData.append('pdf', pdfBlob, pdfFileName);
        console.log(formData)
        // Send to Django backend to save and upload to Google Drive
        fetch('/finance/save-and-upload/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log("PDF saved and uploaded to Google Drive successfully!");
            } else {
                console.log("Failed to upload PDF to Google Drive.");
            }
        })
        .catch(error => console.error('Error uploading PDF:', error));
    }
</script>

<!-- Existing CSS Styles -->
<style>
    .header {
/* Finance Section */
       background: rgb(46, 125, 50); /* Darker green */
       color: white;
       padding: 20px;
       text-align: center;
       font-size: 40px;
       font-weight: bold;
       height: 200px;
       display: flex;
       justify-content: center;
       align-items: center;
   }
   .instructions {
        width: 60%;
        margin: 20px auto;
        text-align: center;
        font-size: 18px;
        color: #333;
    }

    .instructions p {
        line-height: 1.6;
    }
    .container {
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); 
        padding: 10px;
    }
    h2 {
        text-align: center;
        color: #0b1c7a; 
        margin-bottom: 15px; 
    }

    .amounts {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin: 20px 0;
}

.amounts .row1,
.amounts .row2 {
    display: flex;
    justify-content: space-between;
    gap: 10px;
}

.part {
    flex: 1;
    border: 1px solid #ccc;
    padding: 20px;
    text-align: center;
    margin: 0 10px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s;
}

@media (max-width: 768px) {
    .amounts .row1, .amounts .row2 {
        flex-direction: column;
    }
}

.part:hover {
    transform: scale(1.02); 
}

.table-borderless th,
.table-borderless td {
    border: none;
    padding: 10px; 
    text-align: left; 
}

.status {
    margin-top: 20px;
    font-weight: bold;
    color: #dc3545; 
}

.button-container {
    display: flex; 
    justify-content: space-between;
    margin: 20px 0; 
}

.print-button,
.send-button {
    padding: 12px; 
    color: white; 
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px; 
    width: 200px; 
}

.print-button {
    background-color: #28a745;
    margin-left: 150px;
}

.print-button:hover {
    background-color: #074915; 
}

.send-button {
    background-color: #28a745; 
    margin-right: 150px;
}

.send-button:hover {
    background-color: #072b52; 
}

@media (max-width: 768px) {
    .amounts {
        flex-direction: column;
    }

    .part {
        flex: 1 1 100%; 
        margin-bottom: 15px;
    }
}

@media (max-width: 576px) {
    .button-container {
        flex-direction: column;
        align-items: center;
        gap: 15px;
    }

    .print-button,
    .send-button {
        width: 100%;
        max-width: 200px;
        margin: 10px 0;
    }

    .print-button {
        margin-left: 0;
    }

    .send-button {
        margin-right: 0;
    }
}

label {
        margin-top: 10px;
        font-weight: bold; /* Make labels bold */
    }

input, select, button {
    width: calc(100% - 22px); /* Full width minus padding */
    padding: 10px;
    margin: 5px 0;
    border: 1px solid #ccc;
    border-radius: 5px;
}

button {
    background-color: #28a745;
    color: white;
    border: none;
    cursor: pointer;
}

button:hover {
    background-color: #0d6121; /* Darker blue on hover */
}
.styled-input {
    display: inline-block;
    padding: 10px;
    border: 2px solid #ccc;
    border-radius: 4px;
    background-color: #f9f9f9;
    color: black;
    font-size: 16px;
    width: 98%;
    box-sizing: border-box;
    cursor: default;
    outline: none;
}

.styled-input:focus {
    border-color: black;
}

.styled-input:hover {
    border-color: black;
}

/* Contact Section Styles */
.contact-section {
    width: 50%;
    margin: 20px auto;
    text-align: center;
    font-size: 16px;
}

.contact-section a {
    color: #007bff;
    text-decoration: none;
    font-weight: bold;
}

.contact-section a:hover {
    text-decoration: underline;
}
</style>
{% endblock content %}
